# TODO.md

开发进度跟踪和任务列表

## 项目状态

**go-dicom-codec** 是一个为 DICOM 医学影像提供图像编解码功能的 Go 库，支持 JPEG、JPEG-LS 和 JPEG 2000 系列编解码器。

本库专注于编解码器的实现，不涉及 DICOM 封装、分片、元数据等处理（这些由外部 DICOM 库负责）。

### 当前状态
- ✅ 项目架构重构完成 (2025-11-10)
- ✅ JPEG Baseline 编解码器 (1.2.840.10008.1.2.4.50)
- ✅ JPEG Lossless 编解码器 (1.2.840.10008.1.2.4.57) - 所有 7 个预测器
- ✅ JPEG Lossless SV1 编解码器 (1.2.840.10008.1.2.4.70)
- ✅ JPEG Extended (12-bit) 编解码器 (1.2.840.10008.1.2.4.51)
- ✅ JPEG-LS Lossless 编解码器 (1.2.840.10008.1.2.4.80)
- ✅ JPEG-LS Near-Lossless 编解码器 (1.2.840.10008.1.2.4.81) - **完成!** 🎉
  - ✅ 核心功能完成 (NEAR=0-5 完全工作)
  - ✅ Codec 接口实现和注册
  - ⚠️ NEAR≥7 大图像有已知问题 (可后续优化)
- ⏳ JPEG 2000 系列 (计划中)

---

## 第一阶段: 核心架构 ✅ (已完成)

### 1.1 项目重构 ✅
- [x] 重命名项目: go-jpeg → go-dicom-codec
- [x] 更新模块路径: github.com/cocosip/go-dicom-codec
- [x] 创建核心接口包 `codec/`
  - [x] `codec/codec.go` - 编解码器接口定义
  - [x] `codec/registry.go` - 编解码器注册和管理
  - [x] `codec/errors.go` - 通用错误定义
- [x] 重组目录结构
  - [x] `jpeg/` - JPEG 系列编解码器
  - [x] `jpeg/common/` - JPEG 公共工具
  - [x] `jpeg/baseline/` - Baseline 编解码器
  - [x] `jpeg/lossless14sv1/` - Lossless SV1 编解码器
- [x] 更新所有导入路径
- [x] 更新文档 (README.md, CLAUDE.md, TODO.md)

### 1.2 核心接口设计 ✅
- [x] `Codec` 接口: Encode(), Decode(), UID(), Name()
- [x] `EncodeParams` 结构: 统一的编码参数
- [x] `DecodeResult` 结构: 统一的解码结果
- [x] `Options` 接口: 编解码器特定选项
- [x] 注册表模式: 支持按名称或 UID 查找编解码器

---

## 第二阶段: JPEG 系列

### 2.1 JPEG Baseline (1.2.840.10008.1.2.4.50) ✅ (已完成)
- [x] **实现状态**: 完全实现并测试通过
- [x] 编码器: 支持 8-bit 灰度和 RGB 图像
- [x] 解码器: 完整的 JPEG Baseline 解析
- [x] 测试覆盖:
  - [x] 单元测试 (编码/解码)
  - [x] 往返测试
  - [x] 与 Go 标准库互操作性验证
  - [x] 性能基准测试
- [x] 性能: 编码 ~1.17ms, 解码 ~2.97ms (512x512 灰度)

### 2.2 JPEG Lossless SV1 (1.2.840.10008.1.2.4.70) ✅ (已完成)
- [x] **实现状态**: 完全实现并测试通过
- [x] 编码器: 预测器 1 (左像素) 实现
- [x] 解码器: SOF3 解析和差分解码
- [x] 支持 2-16 bit 精度
- [x] 测试覆盖:
  - [x] 8-bit 灰度和 RGB 测试
  - [x] 完美重建验证 (0 误差)
  - [x] 性能基准测试
- [x] 性能: 编码 ~3.65ms, 解码 ~40.2ms (512x512 灰度)

### 2.3 JPEG Extended (1.2.840.10008.1.2.4.51) ✅ (已完成)
- [x] **实现状态**: 完全实现并测试通过
- [x] **UID**: 1.2.840.10008.1.2.4.51
- [x] **功能**: 8/12-bit 有损压缩, SOF1 标记
- [x] 编码器: 基于 Go 标准库的简化实现
  - [x] 8-bit 直接编码
  - [x] 12-bit 通过缩放实现
  - [x] SOF0 → SOF1 标记转换
- [x] 解码器: 自动检测和处理
  - [x] 检测精度字段
  - [x] SOF1 → SOF0 临时转换
  - [x] 8-bit 结果缩放回 12-bit
- [x] 测试覆盖:
  - [x] 8-bit 编解码 (压缩比 2.37x, 平均误差 1.69)
  - [x] 12-bit 编解码 (压缩比 12.74x, 平均误差 11.88)
  - [x] RGB 图像 (压缩比 4.23x, 最大误差 8)
  - [x] 参数验证和质量级别
- [x] 创建 `Codec` 实现并注册
- [x] 测试状态: ✅ 100% 通过 (11/11)

### 2.4 JPEG Lossless (1.2.840.10008.1.2.4.57) ✅ (已完成)
- [x] **UID**: 1.2.840.10008.1.2.4.57
- [x] **功能**: 通用无损压缩, 支持 7 种预测器
- [x] 实现 `jpeg/lossless/encoder.go`
  - [x] 实现 7 种预测器 (1-7)
  - [x] 自动选择最优预测器
  - [x] 差分编码
- [x] 实现 `jpeg/lossless/decoder.go`
  - [x] 解析预测器选择值 (Ss)
  - [x] 支持所有预测器模式
  - [x] 差分解码
  - [x] 修复字节填充双重处理问题
- [x] 测试
  - [x] 所有预测器测试 (7/7 通过)
  - [x] 完美重建验证 (0 错误)
  - [x] 预测器性能对比
  - [x] RGB 图像测试
- [x] 创建 `Codec` 实现并注册
- [x] 外部接口完整集成
- [x] 性能: 编码 ~12.5ms, 解码 ~8.3ms (512x512 灰度, 预测器 1)

---

## 第三阶段: JPEG-LS 系列 ⏳

### 3.1 JPEG-LS Lossless (1.2.840.10008.1.2.4.80) ✅ (已完成)
- [x] **实现状态**: 完全实现并测试通过
- [x] **UID**: 1.2.840.10008.1.2.4.80
- [x] **功能**: JPEG-LS 无损压缩 (LOCO-I 算法)
- [x] **技术**: 上下文自适应, Golomb-Rice 编码, MED 预测
- [x] 创建目录 `jpegls/lossless/`
- [x] 实现编码器
  - [x] 上下文建模 (729 contexts)
  - [x] Golomb-Rice 编码
  - [x] MED 预测算法
  - [x] Run mode 优化
- [x] 实现解码器
  - [x] Golomb-Rice 解码
  - [x] 上下文重建
  - [x] 预测值计算
- [x] 测试
  - [x] 完美重建验证 (0 错误)
  - [x] 压缩率测试 (4.17x grayscale, 2.51x RGB)
  - [x] 12-bit 支持 (2.94x)
- [x] 创建 `Codec` 实现并注册
- [x] 测试状态: ✅ 100% 通过 (11/11)

### 3.2 JPEG-LS Near-Lossless (1.2.840.10008.1.2.4.81) ✅ (已完成)
- [x] **实现状态**: 完全实现并测试通过
- [x] **UID**: 1.2.840.10008.1.2.4.81
- [x] **功能**: JPEG-LS 近无损压缩 (可配置误差界限)
- [x] 创建目录 `jpegls/nearlossless/`
- [x] 实现 NEAR 参数支持
  - [x] 误差量化/去量化
  - [x] 量化预测值
  - [x] LSE/SOS marker 中的 NEAR 参数
- [x] 实现编码器
  - [x] 量化邻居和误差
  - [x] 重建样本存储
- [x] 实现解码器
  - [x] 解析 NEAR 参数
  - [x] 量化误差解码
- [x] 测试覆盖
  - [x] NEAR=0 (无损): ✅ 完美重建 (0 错误)
  - [x] NEAR=1-5: ✅ 误差界限满足
  - [x] NEAR=3: ✅ 最大误差≤3, 压缩率 5.28x
  - [x] RGB NEAR=3: ✅ 最大误差≤3
  - [x] 压缩率对比测试: ✅ 通过
  - [x] 参数验证: ✅ 通过
  - [x] Codec 接口测试: ✅ 全部通过
  - ⚠️ NEAR≥7 大图像已知问题 (偏差校正发散)
- [x] 创建 `Codec` 实现并注册
- [x] 测试状态: ✅ 100% 通过 (17/17)
- [ ] (可选) 完善 NEAR≥7 的大图像支持

---

## 第四阶段: JPEG 2000 系列 ⏳

### 4.1 技术调研
- [ ] 评估第三方库
  - [ ] OpenJPEG Go bindings
  - [ ] Kakadu (商业)
  - [ ] 纯 Go 实现可行性
- [ ] 选择实现策略
  - [ ] 选项 1: CGO + OpenJPEG
  - [ ] 选项 2: 纯 Go 实现 (长期目标)
  - [ ] 选项 3: 混合方案

### 4.2 JPEG 2000 Lossless (1.2.840.10008.1.2.4.90) ⏳
- [ ] **UID**: 1.2.840.10008.1.2.4.90
- [ ] **功能**: JPEG 2000 Part 1 无损压缩
- [ ] **技术**: 小波变换, EBCOT, 算术编码
- [ ] 创建目录 `jpeg2000/lossless/`
- [ ] 实现编码器 (或集成第三方库)
- [ ] 实现解码器 (或集成第三方库)
- [ ] 测试
  - [ ] 完美重建验证
  - [ ] 与标准测试集对比
- [ ] 创建 `Codec` 实现并注册

### 4.3 JPEG 2000 (1.2.840.10008.1.2.4.91) ⏳
- [ ] **UID**: 1.2.840.10008.1.2.4.91
- [ ] **功能**: JPEG 2000 有损或无损
- [ ] 支持质量参数配置
- [ ] 测试: 压缩率和质量权衡
- [ ] 创建 `Codec` 实现并注册

### 4.4 JPEG 2000 Multi-component (1.2.840.10008.1.2.4.92/93) ⏳
- [ ] **UIDs**: 1.2.840.10008.1.2.4.92 (Lossless), .93 (Lossy)
- [ ] **功能**: JPEG 2000 Part 2 多分量支持
- [ ] 支持多光谱图像
- [ ] 创建 `Codec` 实现并注册

### 4.5 JPEG 2000 High-Throughput (1.2.840.10008.1.2.4.201/202/203) ⏳
- [ ] **UIDs**:
  - 1.2.840.10008.1.2.4.201 (HT Lossless)
  - 1.2.840.10008.1.2.4.202 (HT RPCL Lossless)
  - 1.2.840.10008.1.2.4.203 (HT Lossy/Lossless)
- [ ] **功能**: JPEG 2000 Part 15 高吞吐量变体
- [ ] 优化性能和并行处理
- [ ] 创建 `Codec` 实现并注册

---

## 第五阶段: 性能优化

### 5.1 算法优化
- [ ] DCT/IDCT SIMD 优化
- [ ] 并行处理多个块
- [ ] 内存池减少分配
- [ ] Huffman 查找表优化

### 5.2 性能基准
- [ ] 建立性能基准数据库
- [ ] 跨平台性能测试
- [ ] 内存使用分析
- [ ] 大批量图像处理测试

---

## 第六阶段: 测试和验证

### 6.1 测试覆盖
- [ ] 单元测试覆盖率 > 85%
- [ ] 集成测试: 所有编解码器互操作
- [ ] 边界条件测试
  - [ ] 最小图像 (1x1, 8x8)
  - [ ] 大图像 (4096x4096+)
  - [ ] 非标准尺寸

### 6.2 互操作性测试
- [ ] 与 dcmtk 互操作
- [ ] 与 pydicom 互操作
- [ ] 与其他 DICOM 查看器兼容性

### 6.3 符合性测试
- [ ] DICOM 标准符合性验证
- [ ] 使用标准测试图像集
- [ ] 参考实现对比

---

## 第七阶段: 文档和示例

### 7.1 API 文档
- [ ] 完整 GoDoc 注释
- [ ] 每个公共函数的示例
- [ ] 参数和返回值详细说明

### 7.2 使用指南
- [x] README.md 基础版本
- [ ] 详细使用文档
- [ ] 各编解码器的最佳实践
- [ ] 性能调优指南

### 7.3 示例代码
- [ ] 创建 `examples/` 目录
  - [ ] JPEG Baseline 示例
  - [ ] JPEG Lossless 示例
  - [ ] JPEG-LS 示例
  - [ ] JPEG 2000 示例
  - [ ] 与 DICOM 库集成示例
  - [ ] 批量处理示例

---

## 第八阶段: 发布准备

### 8.1 版本管理
- [ ] 语义化版本 (v0.1.0 → v1.0.0)
- [ ] CHANGELOG.md
- [ ] 版本标签和发布

### 8.2 CI/CD
- [ ] GitHub Actions 配置
  - [ ] 自动化测试
  - [ ] 多平台构建
  - [ ] 性能基准追踪
  - [ ] 代码覆盖率报告

### 8.3 质量保证
- [ ] 代码审查
- [ ] 静态分析 (golangci-lint)
- [ ] 安全扫描
- [ ] LICENSE 文件

---

## 当前优先级

**下一步任务 (按优先级):**

1. ✅ 项目架构重构和核心接口设计
2. ✅ JPEG Baseline 编解码器适配到新架构
3. ✅ JPEG Lossless SV1 编解码器适配到新架构
4. ✅ JPEG Lossless (7 种预测器) 实现 - **已完成** 🎉
5. ✅ JPEG Extended (12-bit) 实现 - **已完成** 🎉
6. ✅ JPEG-LS Lossless 实现 - **已完成** 🎉
7. ✅ JPEG-LS Near-Lossless 实现 - **已完成** 🎉
   - ✅ 编码器和解码器实现完成
   - ✅ NEAR=0-5 全部测试通过
   - ✅ Codec 接口实现和注册
   - ✅ 所有测试通过 (17/17)
8. ⏳ **下一步**: 开发方向选择
   - 选项 A: 优化现有编解码器性能
   - 选项 B: JPEG 2000 技术调研和实现
   - 选项 C: 编写示例代码和使用文档
   - 选项 D: 完善测试覆盖率和互操作性测试

---

## 技术说明

### JPEG 系列
- **标准**: ITU-T T.81 (JPEG), ITU-T T.87 (JPEG Lossless)
- **关键技术**: DCT, 霍夫曼编码, 量化, 预测编码
- **当前状态**: Baseline 和 Lossless SV1 已完成

### JPEG-LS 系列
- **标准**: ITU-T T.87 (ISO/IEC 14495)
- **关键技术**: 上下文自适应, Golomb-Rice 编码, 预测
- **优势**: 更好的无损压缩率, 低复杂度
- **当前状态**: 待实现

### JPEG 2000 系列
- **标准**: ISO/IEC 15444
- **关键技术**: 小波变换, EBCOT, 算术编码
- **优势**: 优秀的压缩率, 渐进式传输, ROI 编码
- **挑战**: 实现复杂度高, 考虑使用第三方库
- **当前状态**: 调研阶段

---

**最后更新**: 2025-11-10

**备注**:
- 本库专注于编解码器实现，不处理 DICOM 封装、分片、元数据等
- Transfer Syntax UID 的定义和管理由外部 DICOM 库负责
- 编解码器可通过 UID 或名称访问
