## 症结分析
- 差异集中在最低比特平面（bp=0）的 MRP 位不同步，典型为解码比编码少细化 1（例如 -127→-126）。
- 这通常源于更早的位消费或上下文偏差，重点怀疑：
  - Cleanup Pass（CP）“最后部分行组”（不足 4 行）的列/行遍历与位序不一致。
  - CP 的 RL gating 条件（是否进入 RL、runlen 的位消费）在编码/解码两端不完全一致。
  - VISIT 生命周期与邻域显著标志（SIG_*）的更新时序导致上下文差异。

## 修复策略
- 统一 CP 的处理策略与位消费：
  - CP-Normal：仅对“非显著”系数消费 ZC 与 SIGN；“已显著”系数完全在 MRP 中处理，不消费 ZC 位。
  - CP-RL：仅当四行组全部未访问，且该组内每个系数自身及邻居均不显著时进入 RL；位序严格为：RL 标志位→runlen 高位→runlen 低位→从 runlen 开始逐行的 ZC/SIGN。
- 统一“最后部分行组”处理：
  - 对不足 4 行的组，编码/解码使用一致的列优先遍历、逐行顺序和 VISIT 标记规则，避免一端走 RL、另一端走 Normal。
- 邻域更新与标记时序：
  - 仅在系数首次成为显著后立即更新邻域标志（SIG_* 与 SIGN_*），确保上下文一致。
  - VISIT 在每个比特平面开始统一清除；在同一比特平面内按通道设置，避免重复处理。
- 位序跟踪与自动对比：
  - 在编码器/解码器中为每次 MQ 调用打点（pass、bitplane、x、y、ctx、bit、顺序号），导出两端序列，自动 diff 首个分叉位置。
- 渐进隔离法：
  - 提供可配置开关：临时禁用 CP 的 RL（仅走 Normal）对比位序与结果，若错误消失则定性问题源在 RL；随后逐步恢复 RL，精确修复 gating 与 runlen 位消费。

## 验证与度量
- 位序一致性：
  - 同一输入下，编码与解码的 MQ 调用序列在每一步（包含 ctx 与 bit）完全一致直至结束。
- 单元测试覆盖：
  - SquareSizes：2x2～64x64 全通过；RectangleSizes：高>宽与宽>高的多组梯度全通过。
  - 最小化重现 `5x5`、`10x10`、`17x17`、`18x18` 特例对比零误差。
- 隔离验证：
  - 禁用 RL 的基线对比，确认错误是否消失，定位 RL 逻辑影响范围。
- 性能与回归：
  - 在关闭调试日志后执行基准，确认无显著性能退化。

## 风险与回滚
- 若修复后仍有位序分叉：
  - 继续细化 CP 的列/行遍历次序与 VISIT 生命周期，增加断言保障编码/解码在关键节点状态一致。
- 提供编译时/运行时开关以快速切换 RL/Normal 策略，保证可控回滚与快速定位。

## 产出与时间预估
- 产出：
  - 对齐后的 CP/RL/Normal/MRP 实现，统一的位序跟踪框架，扩展单元测试与隔离实验脚本。
  - 代码中类/函数均含英文功能注释，中文需用英文引号包裹，符合 Go 语言注释规范。
- 时间：
  - 1～2 天完成实现、位序对比与回归测试；问题复杂度较高，若需进一步对齐 RL 细节，可能延长至 3 天。

## 成功标准
- 所有新增与既有测试用例通过（方形与长方形梯度全绿）。
- 位序跟踪显示编码/解码的 MQ 调用序列一致，无首分叉。
- 实际 DICOM 图像若可用，执行端到端 JPEG2000 Lossless 编解码验证无误差。