# JPEG 2000 与 HTJ2K 对齐计划

> **创建日期**：2026-01-09
> **目标**：将 go-dicom-codec 的 JPEG 2000 和 HTJ2K 实现完全对齐到 OpenJPEG 和 OpenJPH 标准

---

## 📋 项目目标

将 `go-dicom-codec` 的 JPEG 2000 和 HTJ2K 实现完全对齐到参考标准：
- **JPEG 2000 核心**：对齐到 OpenJPEG（ISO/IEC 15444-1:2019）
- **HTJ2K 模块**：对齐到 OpenJPH（ISO/IEC 15444-15:2019）

## ⚙️ 用户优先级设定

✅ **优先级**：JPEG 2000 核心模块优先
✅ **兼容性要求**：100% 位级兼容（字节级一致）
✅ **测试资源**：仅有规范文档（需自行构建测试）
✅ **时间安排**：灵活安排，质量优先

**重要说明**：当前很多功能虽已实现（见 README.md），但可能未完全对齐标准。本计划重点是**验证和修正现有实现**，而非从零开发。

---

## 📊 当前状态分析

### JPEG 2000 实现（Go）
- **代码规模**：~3,600 行核心代码，43,039 行总代码（含测试）
- **模块**：11个核心模块（wavelet, t1, t2, mqc, quantization, rate_distortion, ROI, MCT, colorspace, codestream, encoder/decoder）
- **功能**：支持可逆（5/3）和不可逆（9/7）小波，完整 T1/T2 编解码，ROI、MCT、多层编码

### HTJ2K 实现（Go）
- **代码规模**：44个文件，~5,000 行代码
- **模块**：MEL、MagSgn、VLC、U-VLC、上下文计算、指数预测
- **关键问题**：
  - ❌ VLC 表不完整（802项 vs 应有的2048项）
  - ❌ 简化的 MEL 实现（缺少完整13态状态机）
  - ❌ 上下文计算简化（计数方式 vs 标准JPEG 2000算法）

### 参考实现
- **OpenJPEG**：50,306 行 C 代码，高度优化，完整的 JPEG 2000 Part 1 实现
- **OpenJPH**：15,000 行 C++ 代码，5个 SIMD 变体，标准的 HTJ2K 实现

---

## 🎯 重写策略

### 原则
1. **标准优先**：严格遵循 ISO/IEC 15444-1 和 15444-15 标准
2. **Go 惯用法**：不直接移植 C/C++ 代码，使用 Go 语言特性
3. **可维护性**：清晰的代码结构，完整的注释和文档
4. **向后兼容**：确保现有功能不受破坏
5. **渐进式**：分阶段实施，每阶段可验证
6. **验证为核心**：由于仅有规范文档，需建立完善的规范符合性测试

### 测试策略（针对无参考数据情况）

由于没有 OpenJPEG/OpenJPH 的参考测试数据，验证策略调整为：

#### 1. 规范符合性测试
- 直接根据 ISO/IEC 15444-1 和 15444-15 标准的算法描述编写测试
- 验证每个算法步骤的中间结果
- 使用标准中的示例值（如有）

#### 2. 数学属性验证
- **可逆性测试**：DWT 5/3、RCT 等可逆变换必须完全可逆（误差=0）
- **精度测试**：DWT 9/7 等不可逆变换的重构误差必须在标准范围内
- **概率收敛**：MQ 编码器的概率状态必须收敛

#### 3. 往返测试（Round-trip）
- 编码 → 解码 → 验证
- 无损模式：完全相同
- 有损模式：PSNR/SSIM 在预期范围

#### 4. 边界条件测试
- 最小/最大尺寸图像
- 特殊位深度（1, 8, 12, 16）
- 边界像素值（0, 最大值）
- 奇数/偶数尺寸

#### 5. 交叉验证
- 用自己的编码器编码，自己的解码器解码（内部一致性）
- 逐步引入复杂性（从简单图像到复杂图像）
- 使用已知特性（如全零图像应产生极小码流）

#### 6. 手工构造测试用例
- 根据标准中的算法示例构造输入
- 手工计算预期输出
- 逐步验证每个模块

---

## 📅 实施阶段

### 阶段 1：基础分析与验证（第 1 周）

**目标**：验证当前实现与标准的差异，建立测试基准

#### 1.1 JPEG 2000 核心模块验证

**小波变换（DWT）**
- 文件：`jpeg2000/wavelet/dwt53.go`、`jpeg2000/wavelet/dwt97.go`
- 验证任务：
  1. 对比提升方案系数与 ISO/IEC 15444-1 Annex C
  2. 检查边界处理（对称扩展）
  3. 验证舍入模式
- 关键检查点：
  - `Forward53()/Inverse53()`：确保完全可逆（误差=0）
  - `Forward97()/Inverse97()`：检查重构误差（<10^-6）

**MQ 算术编码器**
- 文件：`jpeg2000/mqc/encoder.go`、`jpeg2000/mqc/decoder.go`
- 验证任务：
  1. 确认 47 态状态机实现（ISO/IEC 15444-1 Annex C, Table C.1-C.4）
  2. 检查概率区间更新算法
  3. 验证重归一化过程（比特发送）
  4. 检查 0xFF 字节填充

**T1 块编码器（EBCOT）**
- 文件：`jpeg2000/t1/encoder.go`、`jpeg2000/t1/decoder.go`、`jpeg2000/t1/context.go`
- 验证任务：
  1. 验证通道顺序（显著性传播、精化、清理）
  2. 检查邻域显著性模式（8 模式）
  3. 确认上下文计算（Table D.1）
  4. 验证游程模式编码

#### 1.2 创建验证测试套件

**新增文件**：
- `jpeg2000/validation/openjpeg_vectors_test.go` - OpenJPEG 测试向量
- `jpeg2000/validation/dwt_precision_test.go` - DWT 精度测试
- `jpeg2000/validation/mqc_states_test.go` - MQ 状态机测试
- `jpeg2000/validation/t1_context_test.go` - T1 上下文测试

---

### 阶段 2：JPEG 2000 核心增强（第 2-3 周）

**目标**：修复和增强核心模块，确保符合标准

#### 2.1 小波变换优化

**文件修改**：
- `jpeg2000/wavelet/dwt53.go` - DWT 5/3 精化
- `jpeg2000/wavelet/dwt97.go` - DWT 9/7 精化

**具体任务**：
1. 实现标准提升方案
2. 添加边界对称扩展
3. 确保整数运算（DWT 5/3）或精确浮点（DWT 9/7）
4. 完全可逆性验证

#### 2.2 MQ 算术编码器增强

**文件修改**：
- `jpeg2000/mqc/encoder.go` - 完整 47 态状态机
- `jpeg2000/mqc/decoder.go` - 状态机对齐

**具体任务**：
1. 实现完整的 47 态状态表（Qe、NMPS、NLPS、Switch）
2. 正确的概率区间更新
3. 重归一化与 0xFF 字节填充
4. 上下文索引映射（19个上下文）

#### 2.3 T1 块编码器增强

**文件修改**：
- `jpeg2000/t1/context.go` - 标准上下文计算
- `jpeg2000/t1/encoder.go` - 通道编码实现
- `jpeg2000/t1/decoder.go` - 验证解码

**具体任务**：
1. 实现标准 8 邻域显著性上下文计算
2. 正确的通道顺序（显著性传播、精化、清理）
3. 游程编码支持
4. 系数状态跟踪（sigma、chi、mu、pi）

---

### 阶段 3：HTJ2K 全面重写（第 4-6 周）

**目标**：完整实现 HTJ2K 模块，对齐 OpenJPH

#### 3.1 VLC 表生成与完善（最高优先级）

**新增文件**：
- `jpeg2000/htj2k/vlc_generator.go` - VLC 表生成器

**文件修改**：
- `jpeg2000/htj2k/vlc_tables.go` - 完整 2048 项 VLC 表

**目标**：生成完整的 VLC_tbl0（1024项）和 VLC_tbl1（1024项）

**关键任务**：
1. 实现 ISO/IEC 15444-15 Annex F 的 VLC 表生成算法
2. 验证码字前缀唯一性
3. 验证码字长度范围（3-7 位）
4. 构建编码查找表

#### 3.2 MEL 编码器完整实现（最高优先级）

**文件修改**：
- `jpeg2000/htj2k/mel.go` - 13 态状态机

**目标**：实现完整的 MEL（Magnitude Exponent Likelihood）编码器

**关键任务**：
1. 实现 13 态状态机（MEL_E 表：[0,0,0,1,1,1,2,2,2,3,3,4,5]）
2. Golomb-Rice 编码（unary + truncated binary）
3. 游程长度编码
4. 状态转移测试

#### 3.3 上下文计算对齐（最高优先级）

**文件修改**：
- `jpeg2000/htj2k/context.go` - 标准 HTJ2K 上下文

**目标**：实现符合 ISO/IEC 15444-15 Clause 7.3.5 的上下文计算

**关键任务**：
1. 初始行上下文（仅基于左邻域，0-1）
2. 非初始行上下文（基于左和上邻域，0-3）
3. 四边形显著性管理
4. 上下文验证测试

#### 3.4 VLC 编解码器重写

**文件修改**：
- `jpeg2000/htj2k/vlc_decoder.go` - 直接数组查找
- `jpeg2000/htj2k/vlc_encoder.go` - 优化查找

**关键任务**：
1. 从哈希表转为直接数组索引（性能优化）
2. 处理字节填充（0xFF 后跟 0x00）
3. 码字长度变化处理（3-7 位）
4. 往返测试

#### 3.5 HT 块编解码器集成

**新增文件**：
- `jpeg2000/htj2k/ht_block_encoder.go` - 完整 HT 块编码器

**文件修改**：
- `jpeg2000/htj2k/ht_block_decoder.go` - 验证解码器

**关键任务**：
1. 完整的清理通道编码
2. 精化通道编码
3. 四边形处理（2×2 样本）
4. 段组装（MagSgn、MEL、VLC）

---

### 阶段 4：集成与测试（第 7 周）

**目标**：确保所有模块正确集成，通过完整测试套件

#### 4.1 JPEG 2000 集成验证

**文件**：
- `jpeg2000/encoder.go`
- `jpeg2000/decoder.go`
- `jpeg2000/lossless/codec.go`
- `jpeg2000/lossy/codec.go`

**任务**：
1. 验证编码器使用增强的模块
2. 运行现有测试套件（116 个测试文件）
3. 确保无回归
4. 性能基准测试

**测试命令**：
```bash
# 运行所有测试
go test ./jpeg2000/... -v

# 运行基准测试
go test ./jpeg2000/... -bench=. -benchmem

# 覆盖率测试
go test ./jpeg2000/... -cover -coverprofile=coverage.out
```

#### 4.2 HTJ2K 集成验证

**文件**：
- `jpeg2000/htj2k/codec.go`
- `jpeg2000/htj2k/encoder.go`
- `jpeg2000/htj2k/decoder.go`

**任务**：
1. 集成新的 HT 块编解码器
2. 验证三种传输语法（201, 202, 203）
3. 与标准 JPEG 2000 的互操作性

#### 4.3 互操作性测试

**新增文件**：
- `jpeg2000/validation/openjpeg_compat_test.go`
- `jpeg2000/htj2k/openjph_compat_test.go`

#### 4.4 回归测试

确保所有现有功能仍然正常工作。

---

### 阶段 5：优化与文档（第 8 周）

**目标**：性能优化和完善文档

#### 5.1 性能分析与优化

**分析命令**：
```bash
# CPU 分析
go test ./jpeg2000/... -cpuprofile=cpu.prof -bench=.
go tool pprof cpu.prof

# 内存分析
go test ./jpeg2000/... -memprofile=mem.prof -bench=.
go tool pprof mem.prof
```

**优化策略**：
1. 预分配缓冲区
2. 减少内存分配
3. 批处理操作
4. 瓦片级并行处理

#### 5.2 文档编写

**新增文件**：
- `jpeg2000/IMPLEMENTATION.md` - 实现细节文档
- `jpeg2000/htj2k/HTJ2K_SPEC.md` - HTJ2K 规范说明
- `jpeg2000/ALIGNMENT.md` - 对齐参考实现的说明

#### 5.3 最终验证

**验证清单**：
- [ ] 所有单元测试通过
- [ ] 集成测试通过
- [ ] 回归测试无失败
- [ ] 性能无明显下降（<10%）
- [ ] 代码覆盖率 >80%
- [ ] 文档完整

---

## 📁 关键文件清单

### JPEG 2000 核心（需要修改）

| 文件路径 | 修改内容 | 优先级 |
|---------|---------|-------|
| `jpeg2000/wavelet/dwt53.go` | 验证可逆性，边界处理 | 高 |
| `jpeg2000/wavelet/dwt97.go` | 验证精度，系数 | 高 |
| `jpeg2000/mqc/encoder.go` | 完整 47 态，字节填充 | 高 |
| `jpeg2000/mqc/decoder.go` | 状态机对齐 | 高 |
| `jpeg2000/t1/encoder.go` | 通道实现 | 高 |
| `jpeg2000/t1/context.go` | 标准上下文计算 | 高 |
| `jpeg2000/t1/decoder.go` | 验证解码 | 中 |

### HTJ2K 模块（需要重写）

| 文件路径 | 修改内容 | 优先级 |
|---------|---------|-------|
| **NEW** `jpeg2000/htj2k/vlc_generator.go` | VLC 表生成器 | 🔴 最高 |
| `jpeg2000/htj2k/vlc_tables.go` | 完整 2048 项 | 🔴 最高 |
| `jpeg2000/htj2k/mel.go` | 13 态状态机 | 🔴 最高 |
| `jpeg2000/htj2k/context.go` | 标准上下文 | 🔴 最高 |
| `jpeg2000/htj2k/vlc_encoder.go` | 优化查找 | 高 |
| `jpeg2000/htj2k/vlc_decoder.go` | 直接数组索引 | 高 |
| **NEW** `jpeg2000/htj2k/ht_block_encoder.go` | 完整编码器 | 高 |
| `jpeg2000/htj2k/ht_block_decoder.go` | 验证解码器 | 高 |
| `jpeg2000/htj2k/codec.go` | 集成 | 中 |

---

## 🎯 里程碑与验收标准

### 里程碑 1：JPEG 2000 核心验证（第 1 周结束）
**验收标准**：
- ✅ DWT 5/3 完全可逆（误差 = 0）
- ✅ DWT 9/7 精度 <10^-6
- ✅ MQ 编码器往返测试通过
- ✅ T1 上下文计算匹配 Table D.1

### 里程碑 2：JPEG 2000 核心增强（第 3 周结束）
**验收标准**：
- ✅ 所有核心模块增强完成
- ✅ 单元测试通过
- ✅ 无损编解码往返成功

### 里程碑 3：HTJ2K VLC 完成（第 4 周结束）
**验收标准**：
- ✅ VLC 表生成器实现
- ✅ VLC_tbl0/tbl1 各 1024 项
- ✅ VLC 往返测试通过

### 里程碑 4：HTJ2K MEL 完成（第 5 周结束）
**验收标准**：
- ✅ 13 态 MEL 编码器实现
- ✅ MEL 解码器实现
- ✅ 状态转移测试通过

### 里程碑 5：HTJ2K 集成（第 6 周结束）
**验收标准**：
- ✅ HT 块编解码器完成
- ✅ 完整 HTJ2K 往返测试
- ✅ 上下文计算正确

### 里程碑 6：集成测试（第 7 周结束）
**验收标准**：
- ✅ 所有测试套件通过
- ✅ 回归测试无失败
- ✅ 互操作性验证

### 里程碑 7：优化与文档（第 8 周结束）
**验收标准**：
- ✅ 性能分析完成
- ✅ 关键优化实施
- ✅ 文档完整
- ✅ 准备发布

---

## ⚠️ 风险管理

### 高风险项
1. **VLC 表完整性** - 缓解：与 OpenJPH 逐项对比验证
2. **MQ 状态机精度** - 缓解：使用标准测试向量验证
3. **性能下降** - 缓解：持续基准测试，回滚低效实现

### 中风险项
1. **向后兼容性** - 缓解：完整回归测试套件
2. **测试数据缺失** - 缓解：自己生成测试向量

---

## 💡 实施建议

### 开发环境
- Go 1.21+
- 测试工具：`go test`, `go bench`
- 性能分析：`pprof`, 火焰图
- 代码覆盖率：`go cover`

### 版本控制策略
- 主分支：`master`
- 特性分支：
  - `feature/jpeg2000-core-enhancement`
  - `feature/htj2k-vlc-tables`
  - `feature/htj2k-mel-encoder`
  - `feature/htj2k-integration`

### 提交消息格式
```
<类型>(<模块>): <简短描述>

<详细说明>

参考：ISO/IEC 15444-X Clause Y.Z
```

### 测试策略
1. **测试驱动开发**（TDD）：先写测试，再实现
2. **持续集成**：每次提交运行测试
3. **性能基准**：每周对比基准测试
4. **代码审查**：所有修改需要审查

---

## 📝 总结

本计划提供了详细的、分阶段的重写路线图，确保：
1. **标准符合性**：严格遵循 ISO/IEC 15444-1 和 15444-15
2. **可维护性**：清晰的代码结构和文档
3. **可测试性**：完整的测试覆盖
4. **性能**：优化关键路径
5. **兼容性**：与 OpenJPEG/OpenJPH 对齐

**预计完成时间**：8 周
**每周都有明确的里程碑和验收标准**

---

## 📞 下一步行动

1. 阅读并理解本计划
2. 选择从哪个阶段开始（建议：阶段 1）
3. 创建对应的特性分支
4. 按计划逐步实施
5. 定期检查里程碑完成情况

**祝对齐工作顺利！** 🚀
